Код сторонних сервисов на проектах
==================================

* [Описание проблемы](#Описание-проблемы)
* [Правила работы с кодом сторонних сервисов на проектах](#Правила-работы-с-кодом-сторонних-сервисов-на-проектах)

Описание проблемы
-----------------

1. При загрузке страницы браузера, до наступления события window.onload все ресурсы, независимо от того грузятся они
   синхронно или асинхронно, должны быть загружены полностью и только потом наступает событие `window.onload`.

2. Все наши js модули начинают работать, только когда наступило событие `window.onload`.

Отсюда вытекают следующие проблемы:

1. Если какой-то сторонний сервис в момент загрузки страницы (до наступления `window.onload` долго не отдает ответ, то 
   это тормозит наступление `window.onload` события. Причем, неважно синхронно либо асинхронно происходит эта загрузка.

2. Если на отображение страницы влияют какие-то js модули, то до тех пор, пока не наступило событие `window.onload`
   страница будет отображаться некорректно.

  * например, lazyload изображения, которые должны показываться при попадании в viewport браузера, на самом деле не 
    будут показываться до тех пор, пока страница полностью не загрузится, так как код их инициализации находится в js 
    модуле.


Правила работы с кодом сторонних сервисов на проектах
-----------------------------------------------------

* Для устранения данной проблемы, коды сторонних сервисов необходимо оборачивать  в js-функцию, которая вызывается после
  наступления события `window.onload`. Таким образом инициализация и работа сторонних сервисов будет происходить уже 
  после полной загрузки страницы проекта и всей нашей функциональности.

  Например:

  сервис сбора аудитории ретаргета Вконтакте - VK Pixel. Код подключения:

  ```javascript
  (window.Image ? (new Image()) : document.createElement('img')).src = 'https://vk.com/rtrg?p=VK-RTRG-${ID}';
  ```

  после применения данных правил:
  ```javascript
  window.addEventListener('load', function() {
    (window.Image ? (new Image()) : document.createElement('img')).src = 'https://vk.com/rtrg?p=VK-RTRG-${ID}';
  });
  ```

  Сторонние сервисы могут добавлять свою функциональность разными способами. Это может быть отправка каких-то параметров
  в сервис с помощью картинок (как в примере), либо внедрение своей javascript библиотеки в наш рантайм.

  **Важно понимать, что оборачивание стороннего кода в `setTimeout` является некорректным. Так как по истечении 
  таймаута `window.onload` еще может не наступить и таким образом мы только увеличим время загрузки страницы.**

* Данное решение нужно обязательно согласовывать с заказчиками (по каждому конкретному случаю), объяснять им почему мы 
  так делаем. Что это влияет на скорость работы и отказоустойчивость проекта.

  Например, при внедрении счетчика посещаемости, нужно объяснить, что он засчитает посещение страницы только после
  полной загрузки данной страницы (после наступления `window.onload`). Но, также, нужно понимать, что чем быстрее 
  будет грузиться страница, тем быстрее наступит событие `window.onload`, тем быстрее отправится статистика в этот 
  сервис; а главный тормоз на данный момент - это как раз сторонние сервисы.

* Если сервис работает по какой-то сложной логике, то, скорее всего, в инструкции по его подключению на проект уже 
  имеется информация по работе с ним в асинхронном режиме. Возможно, она будет полезной для интеграции данного сервиса.

  * Например: [инструкция по подключению рекламной площадки Adfox](https://sites.help.adfox.ru/page/45/#async)

* В местах подключений кодов сторонних сервисов необходимо оставлять ссылку на данную документацию:
  > -#\
  >   Перед изменением/удалением учитывать документацию!\
  >   @see https://github.com/abak-press/guides/tree/master/frontend/performance-optimization/external-code/README.md
