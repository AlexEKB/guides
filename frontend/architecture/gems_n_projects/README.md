# Правила оформления Front-end в гемах и проектах

- [Базовые принципы](#Базовые-принципы)
- [Общие соглашения](#Общие-соглашения)
- [CSS и прочее оформление](#css-и-прочее-оформление)

## Базовые принципы:

### В гемах должна лежать только логика, связанная с гемом

Гем — это независимая от проекта сущность. Она не должна знать о ваших проектных методах,
переменных и какой-то ещё логике. В таком виде его и нужно держать. Исходя из этого — мы не используем
js модули и стили, которые используются только на вашем проекте. И никогда не будем их использовать.

### Гем должен работать и быть презентабелен «из коробки»

Любой из проектов в любое время может поставить себе наш гем. В таких случаях у гема должна работать
вся логика и он должен быть хотя бы на сколько-то презентабельным. Это значит, что у него должны быть
какие-то минимальные стили. Для этой цели в первую очередь нужно стараться использовать то, что заготовлено
в [apress-application](https://github.com/abak-press/apress-application).
Подробнее — [ниже](#Дефолтные-стили).

### Все, что используется в геме, должно быть совместимо со всеми нашими проектами

Все наши проекты движутся с разной скоростью. Разные версии рельс, разные версии гемов. Когда мы пишем код,
мы должны понимать, будет ли он работать на более технически отставших проектах.

Ради примера стоит упомянуть, что сейчас на проектах стоят разные версии Sass.

### Любые изменения в геме не должны ломать работу на других проектах, где этот гем подключен

Изменения, которые мы вносим в гем, не должны ломать что-то на проектах, которые этот гем уже используют.
Очень осторожно подходим к переименованию файлов, рефакторингу, удалению ненужных кусков кода.
Если же ваши изменения точно сломают другим код, но вам всё равно необходимо внести их в гем,
то руководствуемся следующим пунктом.

### Любые изменения в геме должны быть согласованы с ПМами проектов, где этот гем подключен

Если мы меняем что-то в геме, особенно если это какая-то логика, мы обязательно должны согласовать
это с ПМами других проектов, на которых подключен этот гем. Не забываем, что даже самое простое изменение
может что-то у кого-то сломать. И только после того, когда мы убедились, что все со всем согласны,
и все готовы к починке благодаря вашей инструкции — мы меняем логику в геме.

Если же от поломок не уйти, то нужно уведомить всех, кого это касается. И при подключении новой версии гема
ответственное лицо должно внести изменения в код проекта, чтобы всё работало после обновления.

## Общие соглашения

### Вынос сборок и конфига в require папку

Чтобы свести возможность проблем к минимуму, мы выносим файлы с подключением сборок в специальную папку,
которую нельзя перекрывать — `require`. В ней создаются файлы с именами вьюх, в которых подключаются необходимые сборки.
Так же в ней создается файл конфига для js модуля гема. Пример:

```
require/
  _edit.html.haml #------------ В нем подключаются сборки, необходимые странице edit
  _show.html.haml #---------- В нем подключаются сборки, необходимые странице show
  _config.html.haml #--------- В нем описана конфигурация js-модуля гема
show.html.haml
edit.html.haml
```

**ВАЖНО: перекрывать папку /require/ и все файлы в ней нельзя!**

`show.html.haml`

```ruby
= render 'require/show'
= render 'require/config', data_for_module: data_for_module
```

`require/_show.html.haml`

```ruby
- content_for :stylesheets_head do
  = stylesheet_link_tag 'package/gem_name'
- content_for :javascripts_bottom do
  = javascript_include_tag 'package/gem_name', defer: true
```

`require/_config.html.haml`

```javascript
:javascript
  app.config.gemName = {
    option1: #{data_for_module.to_json},
    option2: 43,
    ...: ...
  }
```

### Сторонние компоненты

Все сторонние компоненты (будь то плагины или фреймворки) загружаем через зависимости гема
с сайта https://rails-assets.org/. Для этого нужно в файле гема `gem_name.gamespec` добавить необходимые зависимости:

`gem_name.gemspec`

```
spec.add_runtime_dependency 'rails-assets-handlebars', '~> 3.0.0'
spec.add_runtime_dependency 'rails-assets-jquery-numeric'
```

Затем в `Gemfile` гема прописать сайт `rails-assets.org` к остальным источникам, если он там еще не прописан

`Gemfile`

```
source 'https://gems.railsc.ru'
source 'https://rubygems.org'
source 'https://rails-assets.org' <---
```

Стоит так же проверить, есть ли этот источник в проектном `Gemfile`
Затем в файле сборки js или css в подключаемом проекте просто прописать эти файлы.

`package/gem_name.js`

```
//= require ...
//= require handlebars
//= require jquery-numeric
```

Если необходимо прикрутить сторонний компонент и внести в него изменения, которые нужны всем проектам,
компонент заносится в [apress-application](https://github.com/abak-press/apress-application)
и прикручивается в сборки оттуда.

**Почему не в геме?** Потому что эти же компоненты могут быть востребованы несколькими гемами и внутри проекта.
Нельзя допустить, чтобы на одной странице грузилось несколько дублей одного компонента.

Для того, чтобы любой проект знал, что ему нужно будет проделать те же действия, необходимо прописать
все эти тонкости в документацию к гему, в release notes, указать в реквесте и коментом к задаче в jira.

## Javascript

### Handlebars.js

Когда мы работаем с данным шаблонизатором, мы компилируем шаблоны на бакенде. Для этого в проект нужно установить
гемы `handlebars_assets` и `hamlbars`. Первый позволяет компилировать наши шаблоны в момент создания сборки ассетов.
Второй позволяет составлять их через любимый нами синтаксис haml.

**Как этим пользоваться**

В проекте к нашим (фронт-эндовым) гемам должен быть дописан гем `handlebars_assets`

`Gemfile`

```
gem 'sass-rails', require: 'sass'
gem 'autoprefixer-rails'
gem 'cssminify', require: 'cssminify'

gem 'handlebars_assets'
```

В группе `:assets` должен быть гем `hamlbars`:

`Gemfile`

```
group :assets do
  gem 'therubyracer', require: 'v8'
  gem 'uglifier'

  gem 'hamlbars', '~> 2.1'
end
```

Соответствующий скрипт должен быть подключен в одну из базовых сборок на проекте

`package/package_you_need_in_project.js`

```
//= require ...
//= require handlebars
```

В геме шаблоны можно подключить прямо внутри модуля, в котором они используются, либо внутри гемной сборки.
Подключить можно двумя способами: 1) каждый шаблон по-отдельности, либо 2) всю директорию с нужными шаблонами разом.
В первом случае такой шаблон технически можно будет перекрыть при необходимости в проекте.
Во втором случае перекрыть не получится.

`package/gem_name.js`

```
//= require ...

// подключение всей директории разом
//= require_tree ../templates/gem_name

// подключение каждого шаблона отдельно
//= require templates/gem_name/template_1
//= require templates/gem_name/template_N
```

Папка с шаблонами должна лежать в папке `javascripts/templates/` и называться так же, как и гем.
В папке с шаблонами у нас лежат файлы с расширением `.hamlbars`, выглядят они как обычные haml-вьюхи.

Заполняются шаблоны в модуле так:

`gem_name.js`

```
HandlebarsTemplates['path_to_template']({key: value})
```

- "Живой" пример подключения - https://github.com/abak-press/blizko/pull/5270/files
- "Живой" пример использования - https://github.com/abak-press/apress-companies-pages/pull/14/files
- Доки на handlebars_assets - https://github.com/leshill/handlebars_assets
- Доки на hamlbars - https://github.com/jamesotron/hamlbars

## CSS и прочее оформление

### Дефолтные стили

Как было описано выше — гем при подключении должен быть презентабельным.
Как определить, в каком случае какие стили использовать?

**Если вьюхи, которые вы создаете по задаче, должны будут перекрыться в проекте** (индексируемые ботами страницы),
то в геме создается минимум скелетных вьюх, в которые выведены все необходимые элементы интерфейса,
для визуального различения которых используем заготовки
из [apress-application](https://github.com/abak-press/apress-application): формы, кнопки и т.п.

**Если в геме требуется создать вьюху или жсный шаблон, который нельзя перекрывать:** непубличную форму,
которая не светится незарегистрированным пользователям (в том числе форму, которая будет рендериться
с помощью шаблонов handlebars), непубличную таблицу и т.п. — нужно верстать сразу хорошо.

На этапе планирования необходимо выяснить, какие элементы должны быть уникальными для формы, а какие должны быть
оформлены в том же стиле, что и аналогичные элементы в каждом отдельном проекте. Так как точечно нельзя перекрывать
стандартные стили, то для элементов, которые должны быть уникальными в рамках вашей формы/страницы,
необходимо описывать стили отдельно внутри гема, не используя классы из списка стандартных.
Проект будет иметь возможность перекрыть файл стилей и описать все классы так, как нужно проекту.

Нельзя описывать и использовать в гемах служебные классы с названиями, описывающими внешний вид элемента!
Нельзя описывать и использовать часто используемые классы типа `mb15`, `dib` и т.п.
Есть небольшие исключения для некоторых классов, например `dn`.

### Иконки, графика, элементы управления

Какая графика будет в геме, какого цвета, решает проект, который делает этот гем. Все остальные проекты,
когда забирают гем, перекрывают/перекрашивают имеющиеся ассеты.

Если впоследствии несколько проектов используют один гем и проекту-создателю нужно заменить
какие-нибудь иконки — они также перекрываются на проекте.

### Вьюхи

Вьюхи в геме пишутся только с той логикой, которая нужна гему. Если поверх неё проект решил добавить
что-то своё проектное, но у вас есть сомнения, то на этапе планирования нужно задать заказчикам следующие вопросы:

- действительно ли это нужно только одному проекту?
- пробовали ли вы согласовать изменение для всех проектов сразу внутри гема?

Если изменение действительно нужно только одному проекту и силами гема это конфигурировать нет смысла, то вьюха
дробится таким образом, чтобы перекрыть на проекте можно было только небольшой ее кусочек. Ну и далее в проекте
в перекрытой вьюхе делаются все доп изменения.

Все статичные фразы делаем в ru локали.

### Стандартные стили из apress-application

Особо выделим этот гем. Для фронта в нём содержатся общепроектные стили, жсные модули, иконки и другие полезные вещи.
Все стили, описанные в этом геме, могут быть модифицированы в проекте. Проект должен сам решать, как будет выглядеть
у него стандартная кнопка, стандартное поле для ввода, стандартный селект и так далее. Проект может сделать модификации
отдельно для портала, отдельно для СК, отдельно для ЛК, отдельно для админки. Нельзя модифицировать эти стили точечно
в рамках одного гема, в рамках одной формы/отдельной страницы на проекте. Можно точечно менять позиционирование,
отступы от других элементов, менять выравнивание внутри родителя. Нельзя точечно менять границы, фон, поля, шрифт,
цвет и так далее.
