# Разработка отчетов

* [Организация отчетов](#Организация-отчетов)
* [Область определения отчета](#Область-определения-отчета)
  * [Валидация](#Валидация)
  * [Ограничение требований](#Ограничение-требований)
* [Оформление запроса](#Оформление-запроса)
  * [SQL style guide](#sql-style-guide)
* [Оптимизация запроса](#Оптимизация-запроса)
  * [Выбор источника данных](#Выбор-источника-данных)
  * [Эффективное извлечение данных](#Эффективное-извлечение-данных)
* [Технические требования](#Технические-требования)
  * [Выполнение на репликах](#Выполнение-на-репликах)
  * [Фоновое выполнение](#Фоновое-выполнение)
* [Инструменты разработки отчетов](#Инструменты-разработки-отчетов)


Основа любого отчета -- это запрос в базу данных на получение и обработку данных, необходимых для его построения.

Запрос среднестатистического отчета влечет за собой выполнение операций чтения, сортировки, группировки, фильтрации большого объема данных, что при отсутствии контроля над количеством подобных операций и эффективностью их применения может привести к деградации производительности базы данных и, следовательно, приложения в целом.

Построение отчета также включает в себя извлечение, пост-обработку и вставку данных в файл отчета. Это типовая задача, имеющая типовые решения. Игнорирование их в пользу "изобретения велосипеда" может привести к возникновению типовых ошибок, трудных в отладке и локализации.

Данный раздел содержит рекомендации по обеспечению качества и эффективности отчетов, которым необходимо следовать как при написании новых отчетов, так и дополнении, исправлении и оптимизации существующих.

## Организация отчетов

Постоянное дополнение отчета все новыми данными может привести к возникновению т.н. God-отчета. God-отчет описывает множество сущностей, либо слабосвязанные аспекты одной и той же сущности.

Опознавательные признаки God-отчета:
- содержит большое количество колонок;
- является разреженным (большинство ячеек -- пустые);
- запрос содержит большое количество присоединений таблиц (операций JOIN);
- класс отчета имеет признаки [God-класса](https://sourcemaking.com/antipatterns/the-blob).

God-отчет подвержен изменчивости в силу нарушения [SRP](http://code.tutsplus.com/tutorials/solid-part-1-the-single-responsibility-principle--net-36074), и  потому его сложно поддерживать.

Запрос такого отчета почти невозможно оптимизировать в силу его комплексности.

Более того, God-отчет является причиной расточительности системных ресурсов, т.к. необходимость в получении отчета лишь по одному из аспектов сущности влечет за собой получение и обработку данных для описания множества других ее аспектов, покрытых этим отчетом.

Методы борьбы с God-отчетами и God-классами схожи и опираются на принцип "разделяй и властвуй". Однако, выделение отдельного отчета на каждый из аспектов сущности, может привести к стремительному разрастанию их количества, и сил, требуемых на их поддержку.

Таким образом, рекомендуется придерживаться следующего правила: описание некоторого аспекта сущности в виде отчета, должно быть выполнено либо в существующем отчете, покрывающем сильно связанные с данным аспекты сущности, либо в случае отсутствия такового -- в виде отдельного отчета.

## Область определения отчета

Ограничение входных параметров (уменьшение области определения) отчета -- один из наиболее эффективных способов снизить объем потребляемых им ресурсов системы.

##### Валидация

С целью экономии системных ресурсов необходимо предотвращать построение отчетов для невалидных входных параметров.

###### Примеры
1. В качестве предмета отчета указан несуществующий объект.
2. Указан некорректный временной интервал (например, "начало периода" > "конец периода" или "начало периода" > "текущая дата").
3. В качестве предмета отчета указан объект, не обладающий свойствами, раскрывающимися данным отчетом (например, для отчета, описывающего привязанные к рубрике товары, указана недоступная для привязки товаров рубрика).

##### Ограничение требований

Ограничение требований на входные параметры отчета -- это всегда результат компромисса между желаниями пользователей и возможностями системы.

###### Пример

1. Ограничение длительности временного интервала.
2. Ограничение количества выгружаемых строк отчета.
3. Ограничение множества объектов, для которого возможно построение отчета.

## Оформление запроса

##### SQL style guide

Запрос на получение данных для отчета (как и любой другой SQL-запрос) должен соответствовать принятым стилистическим [правилам](http://www.sqlstyle.guide/#general-1).


## Оптимизация запроса

Неотъемлемым шагом после разработки нового отчета является построение и анализ плана его запроса. В случае модификации существующего отчета, производится построение и анализ планов "до" и "после" модификации.

План запроса строится при помощи команды [EXPLAIN ANALYZE](http://www.postgresql.org/docs/9.2/static/sql-explain.html). Удобным инструментом для анализа планов служит сервис http:///explain.depesz.com

Цель анализа плана запроса -- выявление медленных узлов в плане запроса, а также причин их появления. Рекомендуется ознакомиться с приведенной ниже литературой для изучения азов анализа планов запросов.

На основании проведенного анализа предпринимаются шаги, способствующие ускорению выполнения запроса (например, изменение запроса, построение индексов на таблицах БД и др.).

:exclamation: строить планы запросов необходимо на боевых БД или БД, приближенным к ним по объему данных и аналогичным по структуре (например, БД тестовых стендов)

:exclamation: план запроса должен быть прикреплен к пулл реквесту задачи по разработке отчета (а также план "до" в случае модификации существующего отчета)

###### Литература
- https://conf.railsc.ru/label/DEV/explaining_the_unexplainable

##### Выбор источника данных

Одни и те же данные могут быть представлены в БД как в нормализованном, так и в денормализованном виде. Для построения отчетов необходимо предпочитать использование последних.

Примеры

1. Использовать companies#public_products_count для получения количества публикуемых товаров компании нежели осуществлять JOIN таблиц companies & products
2. Использовать таблицу rubrics_denormalization_tree для построения дерева рубрикатора вместо множественного JOIN таблицы rubrics (см. [например](https://github.com/abak-press/blizko/blob/master/lib/services/rubrics_stats_report.rb)).
3. Использовать таблицу product_denormalizations для получения данных о характеристиках, картинках и группах товара вместо присоединения к таблице products таблиц trait_products, product_images, product_groups.

##### Эффективное извлечение данных

Результат запроса отчета может вернуть большое количество записей и переполнить память. Поэтому рекомендуется извлекать и обрабатывать данные из БД последовательно, по частям (пачками). Данный подход можно и нужно реализовывать при помощи [курсоров](http://www.postgresql.org/docs/9.2/static/plpgsql-cursors.html) или [ruby-обертки](https://github.com/abak-press/pg_tools#Класс-pgtoolscursor) над ними (смотри, [например](https://github.com/abak-press/dk/blob/master/lib/reports/news_statistics_report.rb#L175)).

## Технические требования

##### Выполнение на репликах

С целью снизить нагрузку на мастер-базу, данные для отчета требуется извлекать при помощи соединения, установленного к ее реплике (смотри, [например](https://github.com/abak-press/blizko/blob/master/app/services/company_rubrics_report.rb#L67)). Данный подход является правомерным, поскольку отчеты не требуют выполнения пишущих в БД операций.

##### Фоновое выполнение

Любой отчет должен выполняться в виде фоновой resque-задачи. Инструмент разработки отчетов "resque-reports" (см. ниже) реализует данное требование "из коробки".

## Инструменты разработки отчетов

Рекомендуется использовать стандартный для нашей организации DSL-инструмент разработки отчетов -- [resque-reports](https://github.com/abak-press/resque-reports). Инструмент поддерживает "из коробки" такие фичи как "выполнение отчетов в виде фоновых задач", "кеширование отчетов" и другое.

В простейшем варианте отчет, сформированный при помощи DSL, является описанием следующих составляющих:
- запрос и метод получения данных из БД
- список колонок отчета
- кодировка и директория хранения файлов отчета
- соединение с БД
- название очереди для фоновой задачи

Смотри, [например](https://github.com/abak-press/dk/blob/master/lib/reports/news_statistics_report.rb#L3) или [другие отчеты](http://sources.railsc.ru/?q=%3C%20Resque%3A%3AReports%3A%3A&i=nope&files=&repos=), использующие данный инструмент.