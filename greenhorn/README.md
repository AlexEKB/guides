## Что такое greenhorn?

https://github.com/Le6ow5k1/greenhorn

Github-бот помогающий определить какие комиты были подключены при обновлении гемов в rails приложении.

## Как это выглядит?

![комментарий](comment.png)

## Как это работает?

Бот имеет список проектов за которыми он следит. Это происходит при помощи подписки на вэб-хуки github. Вэб-хуки добавляются в нужном проекте вручную.

При поступлении вэб-хука бот парсит два Gemfile.lock'а, один из ветки в которую заслан ПР, другой из результата ПР. Затем полученные данные сравниваются и строится дифф позволяющий определить какие гемы были добавлены, обновлены или удалены. Если гем был обновлен greenhorn достает по API разницу комитов между версиями (например так https://api.github.com/repos/abak-press/apress-companies/compare/v10.7.0...v10.8.0). Данная информация трансформируется в markdown комментарий, который бот постит в ПР. При этом бот следит какие ПРы уже были проверены и ведет учет созданных комментариев, т. о. если ПР был просто обновлен, то бот обновляет существующий комментарий, а не создает новый.

## Как добавить новый проект в greenhorn?

Заходим на http://greenhorn.railsc.ru, нажимаем На кнопку "+" и заполняем три поля:
- Name - Название проекта для отображения в интерфейсе, например `barmen`
- Github Full Name - полное название гитхаб репозитория, например `abak-press/barmen`
- Gems Organisation - название организации или юзера в гитхаб, где хранятся наши гемы, например `abak-press`

Нажимаем "Create", greenhorn создаст проект и выкачает названия всех гемов находящихся в организации "Gems Organisation". Это и будут те гемы по которым greenhorn будет строить диффы.

После этого в репозитории проекта нужно настроить вэб-хук с такими данными:
- Payload URL: http://login:password@greenhorn.railsc.ru/github-webhook, где login и password это стандартные логин и пароль от HTTP аутентификации, взять можно [здесь](https://conf.railsc.ru/pages/viewpage.action?pageId=24674376)
- Content type: application/json
- Which events would you like to trigger this webhook: Pull request

## Как задеплоить новую версию?

greenhorn крутится в http://rancher.railsc.ru:8000 и состоит из двух основных docker контейнеров: приложения и БД. Image приложения можно найти [здесь](https://hub.docker.com/r/le6ow5k1/greenhorn/). Деплой осуществляется стандартными средствами в интерфейсе rancher.

## Известные проблемы

- greenhorn может постороить дифф только по гемам, находящимся в организации "Gems Organisation" (abak-press в нашем случае). По остальным он просто напишет что гем был обновлен с такой-то до такой-то версии (без комитов).
- greenhorn не может постороить дифф по новым гемам. Для того чтобы greenhorn узнал о новом геме нужно зайти http://greenhorn.railsc.ru, щелкнуть на редактирование проекта и нажать "Update", тогда greenhorn обновит список гемов организации.
- Другие проблемы отражены в [issues](https://github.com/Le6ow5k1/greenhorn/issues)
