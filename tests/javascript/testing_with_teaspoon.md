# Тестирование JS с помощью teaspoon

## Содержание

+ [Инструменты для тестирования](https://github.com/abak-press/apress-application/blob/reg_by_email/docs/tests/javascript/testing_with_teaspoon.md#Инструменты-для-тестирования)
+ [Настройка тестовой среды](https://github.com/abak-press/apress-application/blob/reg_by_email/docs/tests/javascript/testing_with_teaspoon.md#Настройка-тестовой-среды)
+ [Соглашение о конфигурации](https://github.com/abak-press/apress-application/blob/reg_by_email/docs/tests/javascript/testing_with_teaspoon.md#Соглашение-о-конфигурации)
+ [Мокать или не мокать - вот в чём вопрос)](https://github.com/abak-press/apress-application/blob/reg_by_email/docs/tests/javascript/testing_with_teaspoon.md#Мокать-или-не-мокать---вот-в-чём-вопрос)
+ [Подключение дополнительных зависимостей](https://github.com/abak-press/apress-application/blob/reg_by_email/docs/tests/javascript/testing_with_teaspoon.md#Подключение-дополнительных-зависимостей)


## Инструменты для тестирования

- **Гем**

  Тестировать будем ассеты рельсового приложения, поэтому нам нужно выбрать гем для достижения этой цели.

  Для запуска тестов в рельсовом приложении выбран [гем teaspoon](https://github.com/jejacks0n/teaspoon).

- **JS тест-фреймворк**

  Teaspoon позволяет использовать один из следующих JS тест-фреймворков для запуска тестов:
  - Jasmine
  - Mocha
  - QUnit

  Из данного перечня был выбран Jasmine.

- **Assertions library и мок данных**

  Чтобы писать тесты помимо тестового фреймворка нам нужно подобрать assertions library и библиотеку для мока данных.

  В Jasmine уже встроены инструменты и для assertions, и для мока данных. Так что никаких дополнительных зависимостей нам не понадобится.
  Будем пользоваться встроенными инструментами, тем более что они весьма удобны и просты в использовании.

- **Работа с DOM**

  Для работы с DOM гем позволяет выбрать один из инcтрументов для тестирования DOM в браузере без интерфейса (headless browser).

  - PhantomJS
  - Selenium WebDriver
  - Capybara Webkit

  Был выбран PhantomJS.

  Также гем идёт вместе с fixture-библиотекой, позволяющей вам реализовать различные элементы DOM-интерфейса и протестировать их.


## Настройка тестовой среды.

Сам гем или проект, в котором вам предстоит писать JS-тесты, уже, скорее всего, настроен для этого.
Никаких дополнительных настроек вам делать не придётся.

Если всё же тестовая среда не настроена, то обратитесь в группу Пользователей для консультации или поставьте им задачку по настройке тестовой среды
для написания JS-тестов).


## Соглашение о конфигурации.

- **Где пишем тесты**

  Сами спеки, а также fixtures, утилиты, настройки, зависимости для них размещаем в папке spec/javascripts.

- **spec/javascripts/modules**

  Здесь размещаем спеки.

  **Пример**

  Модуль называется some_module.js. Спеки для данного модуля размещаем в spec/javascripts/modules/some_module.spec.js

- **Глобальные зависимости**

  Все глобальные зависимости (например, jquery, handlebars) вы подключаете (с помощью require) в spec_helper.js.

- **Утилиты и настройки**

  Для размещения вспомогательных утилит и тестовых настроек создаём папочку spec/javascripts/support.

  Общие утилиты размещаем в spec/javascripts/support/test_utils.js
  Общие настройки (например, объявление глобальных переменных) - в spec/javascripts/support/test_setups.js

- **fixtures**

  Представим, что ваш модуль обращается к DOM-у для каких-либо манипуляций с ним, для получения каких-либо данных и т.д.

  Для тестирования таких модулей вам нужно будет иметь иметь возможность получить доступ к данным DOM-элементам в своих тестах.

  Для этого вы:

  - создаёте в соответствующей директории fixture - html, необходимый для тестирования того или иного функционала.
  - в тестах загружаете нужный html fixture.load('components/auth_component/dynamic_auth_component/item_to_show_component');
    Выполнив данный метод в it-блоке вы получаете доступ к DOM-элеменам, описанным в вашем html.
    Вне данного it-блока доступа к данному html не будет (после выполнения кода it блока, фрейморк отресетит DOM).


  **Пример**

  Допустим, ваш модуль называется some_module.js. И данный модуль обращается к форме на странице, для того, чтобы навесить обработчик события и пр.
  Чтобы иметь возможность протестировать обработчик события, навешиваемый модулем, нам необходимо прежде всего создать fixture по следующему пути:
  spec/javascripts/modules/some_module/form.html.haml

  После этого в нужном it-блоке вы сможете отстроить DOM с использованием данной fixture следующим образом:

  ````javascript
  it('do some stuff', () => {
    fixture.load('modules/some_module/form');

    /* Здесь мы имеем доступ к форме из modules/some_module/form */
  });

  it('do one more stuff', () => {
    /* Здесь же доступа к форме из modules/some_module/form уже нет */
  });
  `````````````

## Мокать или не мокать - вот в чём вопрос.

  Зачастую вам придётся мокать данные. Юнит тесты не предполагают реального коннекта к базе данных и отправки реальных http-запросов.

  Поэтому вам нужно будет мокать БД, аякс-запросы и прочее.


  - Мокать БД следует в папке spec/javascripts/data/

    Мокаем данные БД в папочке test_data.

    Также здесь должы размещаться мок API БД и пр.

  - Мокать аякс-запросы следует в утилитах в spec/javascripts/support/test_utils.js


## Подключение дополнительных зависимостей.

  Допустим, появилась необходимость в hanldlebars при написании тестов.
  Что необходимо сделать, чтобы получить доступ к библиотеке handlebars в тестовой среде?

  - Подключить гем handlebars_assets.
  - Сделать require гема в teaspoon_env.rb. Данный файл находится в папочке spec.
  - Подключить ассеты в spec/javascripts/spec_helper.js


## Examples

  Много различных примеров вы можете найти по [данной ссылке](https://github.com/abak-press/apress-clearance/tree/reg-by-email/spec/javascripts). Это тесты, написанные для авторизационного компонента.
